name: AEGIS CI Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v3
      with:
        python-version: "3.11"
        
    - name: Install System Dependencies (Linux)
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential
        
    - name: Install Python Libraries
      run: |
        python -m pip install --upgrade pip
        # 1. Install Capstone FIRST to prevent conflict
        pip install capstone==5.0.0.post1
        
        # 2. Install the rest of the stack
        pip install z3-solver==4.12.2
        pip install pydantic==2.5.2
        pip install networkx==3.2.1
        pip install pwntools==4.11.0
        pip install angr==9.2.78
        pip install pytest flake8 mypy
        
    - name: Lint with flake8
      run: |
        # Stop the build if there are syntax errors
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        
    - name: Run Tests
      env:
        PYTHONPATH: .
      run: |
        # Just run pytest. It will automatically read pytest.ini
        # and find all the tests we fixed.
        pytest